#!/usr/bin/env php
<?php

require __DIR__.'/app/bootstrap.php';

use Rancherize\Blueprint\Validation\Exceptions\ValidationFailedException;
use Rancherize\Configuration\Services\ProjectConfiguration;
use Symfony\Component\Console\Application;
use Symfony\Component\EventDispatcher\EventDispatcher;

/**
 * @var EventDispatcher $dispatcher
 */
$dispatcher = container('event');
$application = new Application('rancherize');
$application->setDispatcher($dispatcher);

$dispatcher->addListener(\Symfony\Component\Console\ConsoleEvents::EXCEPTION, function(\Symfony\Component\Console\Event\ConsoleExceptionEvent $event) {

	$e = $event->getException();
	$output = $event->getOutput();


	if ( $e instanceof ValidationFailedException ) {

		$formatter = $output->getFormatter();

		$headline = ' Validation failed ';
		$output->writeln( [
			'',
			' ' . $formatter->format( sprintf( "<error> %s </error>", str_repeat(' ', strlen($headline)) ) ) . ' ',
			$formatter->format(" <error> $headline </error>"),
			' ' . $formatter->format( sprintf( "<error> %s </error>", str_repeat('=', strlen($headline)) ) ) . ' ',
			' ' . $formatter->format( sprintf( "<error> %s </error>", str_repeat(' ', strlen($headline)) ) ) . ' ',
			"",
		]);

		container('validate-service')->print($e, $output);
	}

});

// ... register commands
$commands = require_once __DIR__.'/app/lists/commands.php';
foreach($commands as $commandName) {
    $command = new $commandName;
    $application->add($command);
}

$internalPlugins = require_once __DIR__.'/app/lists/plugins.php';
foreach($internalPlugins as $internalPlugin)
    container('plugin-loader-extra')->registerExtra($internalPlugin);

try {

		/**
	 * @var ProjectConfiguration $projectConfig
	 */
	$projectConfig = container('project-config-service');

	$configuration = container('configuration');
	$configuration = $projectConfig->load($configuration);
	container()->offsetSet('project-config', $configuration);

	/**
	 * @var \Rancherize\Plugin\Loader\PluginLoader $pluginLoader
	 */
	$pluginLoader = container('plugin-loader');
	$pluginLoader->load( $configuration, $application, container() );

} catch(Exception $e) {

    echo "Warning! Load Plugins failed: ". $e->getMessage()."\n";

}


$returnCode = $application->run();


return $returnCode;
